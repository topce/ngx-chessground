function ps(r){return r!==null?{comment:r,variations:[]}:{variations:[]}}function ds(r,t,e,s,i){let a={move:r,variations:i};return t&&(a.suffix=t),e&&(a.nag=e),s!==null&&(a.comment=s),a}function gs(...r){let[t,...e]=r,s=t;for(let i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function ms(r,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){let s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:r,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function _s(r,t){function e(){this.constructor=r}e.prototype=t.prototype,r.prototype=new e}function ne(r,t,e,s){var i=Error.call(this,r);return Object.setPrototypeOf&&Object.setPrototypeOf(i,ne.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}_s(ne,Error);function we(r,t,e){return e=e||" ",r.length>t?r:(t-=r.length,e+=e.repeat(t),r+e.slice(0,t))}ne.prototype.format=function(r){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<r.length;s++)if(r[s].source===this.location.source){e=r[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,a=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,n=this.location.source+":"+a.line+":"+a.column;if(e){var c=this.location.end,u=we("",a.line.toString().length," "),d=e[i.line-1],g=i.line===c.line?c.column:d.length+1,b=g-i.column||1;t+=`
 --> `+n+`
`+u+` |
`+a.line+" | "+d+`
`+u+" | "+we("",i.column-1," ")+we("",b,"^")}else t+=`
 at `+n}return t};ne.buildMessage=function(r,t){var e={literal:function(d){return'"'+i(d.text)+'"'},class:function(d){var g=d.parts.map(function(b){return Array.isArray(b)?a(b[0])+"-"+a(b[1]):a(b)});return"["+(d.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(d){return d.description}};function s(d){return d.charCodeAt(0).toString(16).toUpperCase()}function i(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function a(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function n(d){return e[d.type](d)}function c(d){var g=d.map(n),b,p;if(g.sort(),g.length>0){for(b=1,p=1;b<g.length;b++)g[b-1]!==g[b]&&(g[p]=g[b],p++);g.length=p}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function u(d){return d?'"'+i(d)+'"':"end of input"}return"Expected "+c(r)+" but "+u(t)+" found."};function bs(r,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:Xe},a=Xe,n="[",c='"',u="]",d=".",g="O-O-O",b="O-O",p="0-0-0",_="0-0",w="$",S="{",M="}",Y=";",K="(",N=")",G="1-0",Z="0-1",se="1/2-1/2",oe="*",F=/^[a-zA-Z]/,O=/^[^"]/,Q=/^[0-9]/,J=/^[.]/,Fe=/^[a-zA-Z1-8\-=]/,pt=/^[+#]/,Be=/^[!?]/,qe=/^[^}]/,De=/^[^\r\n]/,Ue=/^[ \t\r\n]/,dt=q("tag pair"),gt=P("[",!1),Ge=P('"',!1),mt=P("]",!1),_t=q("tag name"),Ee=U([["a","z"],["A","Z"]],!1,!1),bt=q("tag value"),Qe=U(['"'],!0,!1),vt=q("move number"),pe=U([["0","9"]],!1,!1),kt=P(".",!1),We=U(["."],!1,!1),Et=q("standard algebraic notation"),Ct=P("O-O-O",!1),wt=P("O-O",!1),yt=P("0-0-0",!1),St=P("0-0",!1),je=U([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),$t=U(["+","#"],!1,!1),xt=q("suffix annotation"),Ve=U(["!","?"],!1,!1),At=q("NAG"),Nt=P("$",!1),Pt=q("brace comment"),Tt=P("{",!1),He=U(["}"],!0,!1),Mt=P("}",!1),It=q("rest of line comment"),Ot=P(";",!1),ze=U(["\r",`
`],!0,!1),Rt=q("variation"),Lt=P("(",!1),Kt=P(")",!1),Ft=q("game termination marker"),Bt=P("1-0",!1),qt=P("0-1",!1),Dt=P("1/2-1/2",!1),Ut=P("*",!1),Gt=q("whitespace"),Ye=U([" ","	","\r",`
`],!1,!1),Qt=function(o,h){return ms(o,h)},Wt=function(o){return Object.fromEntries(o)},jt=function(o,h){return[o,h]},Vt=function(o,h){return{root:o,marker:h}},Ht=function(o,h){return gs(ps(o),...h.flat())},zt=function(o,h,f,k,E){return ds(o,h,f,k,E)},Yt=function(o){return o},Zt=function(o){return o.replace(/[\r\n]+/g," ")},Jt=function(o){return o.trim()},Xt=function(o){return o},es=function(o,h){return{result:o,comment:h}},l=t.peg$currPos|0,ie=[{line:1,column:1}],D=l,de=t.peg$maxFailExpected||[],m=t.peg$silentFails|0,le;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');a=i[t.startRule]}function P(o,h){return{type:"literal",text:o,ignoreCase:h}}function U(o,h,f){return{type:"class",parts:o,inverted:h,ignoreCase:f}}function ts(){return{type:"end"}}function q(o){return{type:"other",description:o}}function Ze(o){var h=ie[o],f;if(h)return h;if(o>=ie.length)f=ie.length-1;else for(f=o;!ie[--f];);for(h=ie[f],h={line:h.line,column:h.column};f<o;)r.charCodeAt(f)===10?(h.line++,h.column=1):h.column++,f++;return ie[o]=h,h}function Je(o,h,f){var k=Ze(o),E=Ze(h),$={source:s,start:{offset:o,line:k.line,column:k.column},end:{offset:h,line:E.line,column:E.column}};return $}function v(o){l<D||(l>D&&(D=l,de=[]),de.push(o))}function ss(o,h,f){return new ne(ne.buildMessage(o,h),o,h,f)}function Xe(){var o,h,f;return o=l,h=is(),f=as(),o=Qt(h,f),o}function is(){var o,h,f;for(o=l,h=[],f=et();f!==e;)h.push(f),f=et();return f=L(),o=Wt(h),o}function et(){var o,h,f,k,E,$,X;return m++,o=l,L(),r.charCodeAt(l)===91?(h=n,l++):(h=e,m===0&&v(gt)),h!==e?(L(),f=rs(),f!==e?(L(),r.charCodeAt(l)===34?(k=c,l++):(k=e,m===0&&v(Ge)),k!==e?(E=ns(),r.charCodeAt(l)===34?($=c,l++):($=e,m===0&&v(Ge)),$!==e?(L(),r.charCodeAt(l)===93?(X=u,l++):(X=e,m===0&&v(mt)),X!==e?o=jt(f,E):(l=o,o=e)):(l=o,o=e)):(l=o,o=e)):(l=o,o=e)):(l=o,o=e),m--,o===e&&m===0&&v(dt),o}function rs(){var o,h,f;if(m++,o=l,h=[],f=r.charAt(l),F.test(f)?l++:(f=e,m===0&&v(Ee)),f!==e)for(;f!==e;)h.push(f),f=r.charAt(l),F.test(f)?l++:(f=e,m===0&&v(Ee));else h=e;return h!==e?o=r.substring(o,l):o=h,m--,o===e&&(h=e,m===0&&v(_t)),o}function ns(){var o,h,f;for(m++,o=l,h=[],f=r.charAt(l),O.test(f)?l++:(f=e,m===0&&v(Qe));f!==e;)h.push(f),f=r.charAt(l),O.test(f)?l++:(f=e,m===0&&v(Qe));return o=r.substring(o,l),m--,h=e,m===0&&v(bt),o}function as(){var o,h,f;return o=l,h=tt(),L(),f=us(),f===e&&(f=null),L(),o=Vt(h,f),o}function tt(){var o,h,f,k;for(o=l,h=Ce(),h===e&&(h=null),f=[],k=st();k!==e;)f.push(k),k=st();return o=Ht(h,f),o}function st(){var o,h,f,k,E,$,X,ge;if(o=l,L(),os(),L(),h=ls(),h!==e){for(f=cs(),f===e&&(f=null),k=[],E=it();E!==e;)k.push(E),E=it();for(E=L(),$=Ce(),$===e&&($=null),X=[],ge=rt();ge!==e;)X.push(ge),ge=rt();o=zt(h,f,k,$,X)}else l=o,o=e;return o}function os(){var o,h,f,k,E,$;for(m++,o=l,h=[],f=r.charAt(l),Q.test(f)?l++:(f=e,m===0&&v(pe));f!==e;)h.push(f),f=r.charAt(l),Q.test(f)?l++:(f=e,m===0&&v(pe));if(r.charCodeAt(l)===46?(f=d,l++):(f=e,m===0&&v(kt)),f!==e){for(k=L(),E=[],$=r.charAt(l),J.test($)?l++:($=e,m===0&&v(We));$!==e;)E.push($),$=r.charAt(l),J.test($)?l++:($=e,m===0&&v(We));h=[h,f,k,E],o=h}else l=o,o=e;return m--,o===e&&(h=e,m===0&&v(vt)),o}function ls(){var o,h,f,k,E,$;if(m++,o=l,h=l,r.substr(l,5)===g?(f=g,l+=5):(f=e,m===0&&v(Ct)),f===e&&(r.substr(l,3)===b?(f=b,l+=3):(f=e,m===0&&v(wt)),f===e&&(r.substr(l,5)===p?(f=p,l+=5):(f=e,m===0&&v(yt)),f===e&&(r.substr(l,3)===_?(f=_,l+=3):(f=e,m===0&&v(St)),f===e))))if(f=l,k=r.charAt(l),F.test(k)?l++:(k=e,m===0&&v(Ee)),k!==e){if(E=[],$=r.charAt(l),Fe.test($)?l++:($=e,m===0&&v(je)),$!==e)for(;$!==e;)E.push($),$=r.charAt(l),Fe.test($)?l++:($=e,m===0&&v(je));else E=e;E!==e?(k=[k,E],f=k):(l=f,f=e)}else l=f,f=e;return f!==e?(k=r.charAt(l),pt.test(k)?l++:(k=e,m===0&&v($t)),k===e&&(k=null),f=[f,k],h=f):(l=h,h=e),h!==e?o=r.substring(o,l):o=h,m--,o===e&&(h=e,m===0&&v(Et)),o}function cs(){var o,h,f;for(m++,o=l,h=[],f=r.charAt(l),Be.test(f)?l++:(f=e,m===0&&v(Ve));f!==e;)h.push(f),h.length>=2?f=e:(f=r.charAt(l),Be.test(f)?l++:(f=e,m===0&&v(Ve)));return h.length<1?(l=o,o=e):o=h,m--,o===e&&(h=e,m===0&&v(xt)),o}function it(){var o,h,f,k,E;if(m++,o=l,L(),r.charCodeAt(l)===36?(h=w,l++):(h=e,m===0&&v(Nt)),h!==e){if(f=l,k=[],E=r.charAt(l),Q.test(E)?l++:(E=e,m===0&&v(pe)),E!==e)for(;E!==e;)k.push(E),E=r.charAt(l),Q.test(E)?l++:(E=e,m===0&&v(pe));else k=e;k!==e?f=r.substring(f,l):f=k,f!==e?o=Yt(f):(l=o,o=e)}else l=o,o=e;return m--,o===e&&m===0&&v(At),o}function Ce(){var o;return o=hs(),o===e&&(o=fs()),o}function hs(){var o,h,f,k,E;if(m++,o=l,r.charCodeAt(l)===123?(h=S,l++):(h=e,m===0&&v(Tt)),h!==e){for(f=l,k=[],E=r.charAt(l),qe.test(E)?l++:(E=e,m===0&&v(He));E!==e;)k.push(E),E=r.charAt(l),qe.test(E)?l++:(E=e,m===0&&v(He));f=r.substring(f,l),r.charCodeAt(l)===125?(k=M,l++):(k=e,m===0&&v(Mt)),k!==e?o=Zt(f):(l=o,o=e)}else l=o,o=e;return m--,o===e&&(h=e,m===0&&v(Pt)),o}function fs(){var o,h,f,k,E;if(m++,o=l,r.charCodeAt(l)===59?(h=Y,l++):(h=e,m===0&&v(Ot)),h!==e){for(f=l,k=[],E=r.charAt(l),De.test(E)?l++:(E=e,m===0&&v(ze));E!==e;)k.push(E),E=r.charAt(l),De.test(E)?l++:(E=e,m===0&&v(ze));f=r.substring(f,l),o=Jt(f)}else l=o,o=e;return m--,o===e&&(h=e,m===0&&v(It)),o}function rt(){var o,h,f,k;return m++,o=l,L(),r.charCodeAt(l)===40?(h=K,l++):(h=e,m===0&&v(Lt)),h!==e?(f=tt(),f!==e?(L(),r.charCodeAt(l)===41?(k=N,l++):(k=e,m===0&&v(Kt)),k!==e?o=Xt(f):(l=o,o=e)):(l=o,o=e)):(l=o,o=e),m--,o===e&&m===0&&v(Rt),o}function us(){var o,h,f;return m++,o=l,r.substr(l,3)===G?(h=G,l+=3):(h=e,m===0&&v(Bt)),h===e&&(r.substr(l,3)===Z?(h=Z,l+=3):(h=e,m===0&&v(qt)),h===e&&(r.substr(l,7)===se?(h=se,l+=7):(h=e,m===0&&v(Dt)),h===e&&(r.charCodeAt(l)===42?(h=oe,l++):(h=e,m===0&&v(Ut))))),h!==e?(L(),f=Ce(),f===e&&(f=null),o=es(h,f)):(l=o,o=e),m--,o===e&&(h=e,m===0&&v(Ft)),o}function L(){var o,h;for(m++,o=[],h=r.charAt(l),Ue.test(h)?l++:(h=e,m===0&&v(Ye));h!==e;)o.push(h),h=r.charAt(l),Ue.test(h)?l++:(h=e,m===0&&v(Ye));return m--,h=e,m===0&&v(Gt),o}if(le=a(),t.peg$library)return{peg$result:le,peg$currPos:l,peg$FAILED:e,peg$maxFailExpected:de,peg$maxFailPos:D};if(le!==e&&l===r.length)return le;throw le!==e&&l<r.length&&v(ts()),ss(de,D<r.length?r.charAt(D):null,D<r.length?Je(D,D+1):Je(D,D))}var _e=0xffffffffffffffffn;function ye(r,t){return(r<<t|r>>64n-t)&0xffffffffffffffffn}function nt(r,t){return r*t&_e}function vs(r){return function(){let t=BigInt(r&_e),e=BigInt(r>>64n&_e),s=nt(ye(nt(t,5n),7n),9n);return e^=t,t=(ye(t,24n)^e^e<<16n)&_e,e=ye(e,37n),r=e<<64n|t,s}}var ve=vs(0xa187eb39cdcaed8f31c4b365b102e01en),ks=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ve()))),Es=Array.from({length:8},()=>ve()),Cs=Array.from({length:16},()=>ve()),Se=ve(),R="w",B="b",x="p",Pe="n",be="b",he="r",V="q",A="k",$e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",re=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){let{color:s,piece:i,from:a,to:n,flags:c,captured:u,promotion:d}=e,g=T(a),b=T(n);this.color=s,this.piece=i,this.from=g,this.to=b,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=g+b,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(let p in y)y[p]&c&&(this.flags+=ee[p]);u&&(this.captured=u),d&&(this.promotion=d,this.lan+=d)}isCapture(){return this.flags.indexOf(ee.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ee.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ee.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ee.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ee.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ee.BIG_PAWN)>-1}},I=-1,ee={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"};var y={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Te={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},ws={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},ys={...Te,...ws},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},xe={b:[16,32,17,15],w:[-16,-32,-17,-15]},at={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ss=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],$s=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],xs={p:1,n:2,b:4,r:8,q:16,k:32},As="pnbrqkPNBRQK",ot=[Pe,be,he,V],Ns=7,Ps=6,Ts=1,Ms=0,me={[A]:y.KSIDE_CASTLE,[V]:y.QSIDE_CASTLE},W={w:[{square:C.a1,flag:y.QSIDE_CASTLE},{square:C.h1,flag:y.KSIDE_CASTLE}],b:[{square:C.a8,flag:y.QSIDE_CASTLE},{square:C.h8,flag:y.KSIDE_CASTLE}]},Is={b:Ts,w:Ps},Ae="--";function te(r){return r>>4}function fe(r){return r&15}function ct(r){return"0123456789".indexOf(r)!==-1}function T(r){let t=fe(r),e=te(r);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function ce(r){return r===R?B:R}function Os(r){let t=r.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<i.length;n++){let c=0,u=!1;for(let d=0;d<i[n].length;d++)if(ct(i[n][d])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};c+=parseInt(i[n][d],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[n][d]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};c+=1,u=!1}if(c!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let a=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:n,regex:c}of a){if(!c.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${n} king`};if((t[0].match(c)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${n} kings`}}return Array.from(i[0]+i[7]).some(n=>n.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Rs(r,t){let e=r.from,s=r.to,i=r.piece,a=0,n=0,c=0;for(let u=0,d=t.length;u<d;u++){let g=t[u].from,b=t[u].to,p=t[u].piece;i===p&&e!==g&&s===b&&(a++,te(e)===te(g)&&n++,fe(e)===fe(g)&&c++)}return a>0?n>0&&c>0?T(e):c>0?T(e).charAt(1):T(e).charAt(0):""}function j(r,t,e,s,i,a=void 0,n=y.NORMAL){let c=te(s);if(i===x&&(c===Ns||c===Ms))for(let u=0;u<ot.length;u++){let d=ot[u];r.push({color:t,from:e,to:s,piece:i,captured:a,promotion:d,flags:n|y.PROMOTION})}else r.push({color:t,from:e,to:s,piece:i,captured:a,flags:n})}function lt(r){let t=r.charAt(0);return t>="a"&&t<="h"?r.match(/[a-h]\d.*[a-h]\d/)?void 0:x:(t=t.toLowerCase(),t==="o"?A:t)}function Ne(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var ae=class{_board=new Array(128);_turn=R;_header={};_kings={w:I,b:I};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=$e,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:I,b:I},this._turn=R,this._castling={w:0,b:0},this._epSquare=I,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...ys},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){let c=["-","-","0","1"];t=i.concat(c.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){let{ok:c,error:u}=Os(t);if(!c)throw new Error(u)}let a=i[0],n=0;this.clear({preserveHeaders:s});for(let c=0;c<a.length;c++){let u=a.charAt(c);if(u==="/")n+=8;else if(ct(u))n+=parseInt(u,10);else{let d=u<"a"?R:B;this._put({type:u.toLowerCase(),color:d},T(n)),n++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=y.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=y.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=y.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=y.QSIDE_CASTLE),this._epSquare=i[3]==="-"?I:C[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let n=C.a8;n<=C.h1;n++){if(this._board[n]){e>0&&(s+=e,e=0);let{color:c,type:u}=this._board[n];s+=c===R?u.toUpperCase():u.toLowerCase()}else e++;n+1&136&&(e>0&&(s+=e),n!==C.h1&&(s+="/"),e=0,n+=8)}let i="";this._castling[R]&y.KSIDE_CASTLE&&(i+="K"),this._castling[R]&y.QSIDE_CASTLE&&(i+="Q"),this._castling[B]&y.KSIDE_CASTLE&&(i+="k"),this._castling[B]&y.QSIDE_CASTLE&&(i+="q"),i=i||"-";let a="-";if(this._epSquare!==I)if(t)a=T(this._epSquare);else{let n=this._epSquare+(this._turn===R?16:-16),c=[n+1,n-1];for(let u of c){if(u&136)continue;let d=this._turn;if(this._board[u]?.color===d&&this._board[u]?.type===x){this._makeMove({color:d,from:u,to:this._epSquare,piece:x,captured:x,flags:y.EP_CAPTURE});let g=!this._isKingAttacked(d);if(this._undoMove(),g){a=T(this._epSquare);break}}}}return[s,this._turn,i,a,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:e,type:s}=this._board[t],i={w:0,b:1}[e],a={p:0,n:1,b:2,r:3,q:4,k:5}[s];return ks[i][a][t]}_epKey(){return this._epSquare===I?0n:Es[this._epSquare&7]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return Cs[t]}_computeHash(){let t=0n;for(let e=C.a8;e<=C.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Se),t}_updateSetup(t){this._history.length>0||(t!==$e?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load($e)}get(t){return this._board[C[t]]}findPiece(t){let e=[];for(let s=C.a8;s<=C.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(T(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(As.indexOf(t.toLowerCase())===-1||!(s in C))return!1;let i=C[s];if(t==A&&!(this._kings[e]==I||this._kings[e]==i))return!1;let a=this._board[i];return a&&a.type===A&&(this._kings[a.color]=I),this._set(i,{type:t,color:e}),t===A&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let e=this.get(t);return this._clear(C[t]),e&&e.type===A&&(this._kings[e.color]=I),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[C.e1]?.type===A&&this._board[C.e1]?.color===R,e=this._board[C.e8]?.type===A&&this._board[C.e8]?.color===B;(!t||this._board[C.a1]?.type!==he||this._board[C.a1]?.color!==R)&&(this._castling.w&=-65),(!t||this._board[C.h1]?.type!==he||this._board[C.h1]?.color!==R)&&(this._castling.w&=-33),(!e||this._board[C.a8]?.type!==he||this._board[C.a8]?.color!==B)&&(this._castling.b&=-65),(!e||this._board[C.h8]?.type!==he||this._board[C.h8]?.color!==B)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===I)return;let t=this._epSquare+(this._turn===R?-16:16),e=this._epSquare+(this._turn===R?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==ce(this._turn)||this._board[e]?.type!==x){this._hash^=this._epKey(),this._epSquare=I;return}let i=a=>!(a&136)&&this._board[a]?.color===this._turn&&this._board[a]?.type===x;s.some(i)||(this._hash^=this._epKey(),this._epSquare=I)}_attacked(t,e,s){let i=[];for(let a=C.a8;a<=C.h1;a++){if(a&136){a+=7;continue}if(this._board[a]===void 0||this._board[a].color!==t)continue;let n=this._board[a],c=a-e;if(c===0)continue;let u=c+119;if(Ss[u]&xs[n.type]){if(n.type===x){if(c>0&&n.color===R||c<=0&&n.color===B)if(s)i.push(T(a));else return!0;continue}if(n.type==="n"||n.type==="k")if(s){i.push(T(a));continue}else return!0;let d=$s[u],g=a+d,b=!1;for(;g!==e;){if(this._board[g]!=null){b=!0;break}g+=d}if(!b)if(s){i.push(T(a));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){let e=this._kings[t];return e===-1?!1:this._attacked(ce(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},e=[],s=0,i=0;for(let a=C.a8;a<=C.h1;a++){if(i=(i+1)%2,a&136){a+=7;continue}let n=this._board[a];n&&(t[n.type]=n.type in t?t[n.type]+1:1,n.type===be&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[be]===1||t[Pe]===1))return!0;if(s===t[be]+2){let a=0,n=e.length;for(let c=0;c<n;c++)a+=e[c];if(a===0||a===n)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){let i=this._moves({square:e,piece:s});return t?i.map(a=>new re(this,a)):i.map(a=>this._moveToSan(a,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){let i=s?s.toLowerCase():void 0,a=e?.toLowerCase(),n=[],c=this._turn,u=ce(c),d=C.a8,g=C.h1,b=!1;if(i)if(i in C)d=g=C[i],b=!0;else return[];for(let _=d;_<=g;_++){if(_&136){_+=7;continue}if(!this._board[_]||this._board[_].color===u)continue;let{type:w}=this._board[_],S;if(w===x){if(a&&a!==w)continue;S=_+xe[c][0],this._board[S]||(j(n,c,_,S,x),S=_+xe[c][1],Is[c]===te(_)&&!this._board[S]&&j(n,c,_,S,x,void 0,y.BIG_PAWN));for(let M=2;M<4;M++)S=_+xe[c][M],!(S&136)&&(this._board[S]?.color===u?j(n,c,_,S,x,this._board[S].type,y.CAPTURE):S===this._epSquare&&j(n,c,_,S,x,x,y.EP_CAPTURE))}else{if(a&&a!==w)continue;for(let M=0,Y=at[w].length;M<Y;M++){let K=at[w][M];for(S=_;S+=K,!(S&136);){if(!this._board[S])j(n,c,_,S,w);else{if(this._board[S].color===c)break;j(n,c,_,S,w,this._board[S].type,y.CAPTURE);break}if(w===Pe||w===A)break}}}}if((a===void 0||a===A)&&(!b||g===this._kings[c])){if(this._castling[c]&y.KSIDE_CASTLE){let _=this._kings[c],w=_+2;!this._board[_+1]&&!this._board[w]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,_+1)&&!this._attacked(u,w)&&j(n,c,this._kings[c],w,A,void 0,y.KSIDE_CASTLE)}if(this._castling[c]&y.QSIDE_CASTLE){let _=this._kings[c],w=_-2;!this._board[_-1]&&!this._board[_-2]&&!this._board[_-3]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,_-1)&&!this._attacked(u,w)&&j(n,c,this._kings[c],w,A,void 0,y.QSIDE_CASTLE)}}if(!t||this._kings[c]===-1)return n;let p=[];for(let _=0,w=n.length;_<w;_++)this._makeMove(n[_]),this._isKingAttacked(c)||p.push(n[_]),this._undoMove();return p}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Ae,e);else if(typeof t=="object"){let a=this._moves();for(let n=0,c=a.length;n<c;n++)if(t.from===T(a[n].from)&&t.to===T(a[n].to)&&(!("promotion"in a[n])||t.promotion===a[n].promotion)){s=a[n];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&y.NULL_MOVE)throw new Error("Null move not allowed when in check");let i=new re(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){let e=this._turn,s=ce(e);if(this._push(t),t.flags&y.NULL_MOVE){e===B&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=I;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&y.EP_CAPTURE&&(this._turn===B?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===A){if(this._kings[e]=t.to,t.flags&y.KSIDE_CASTLE){let i=t.to-1,a=t.to+1;this._movePiece(a,i)}else if(t.flags&y.QSIDE_CASTLE){let i=t.to+1,a=t.to-2;this._movePiece(a,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,a=W[e].length;i<a;i++)if(t.from===W[e][i].square&&this._castling[e]&W[e][i].flag){this._castling[e]^=W[e][i].flag;break}}if(this._castling[s]){for(let i=0,a=W[s].length;i<a;i++)if(t.to===W[s][i].square&&this._castling[s]&W[s][i].flag){this._castling[s]^=W[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&y.BIG_PAWN){let i;e===B?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===x&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===x&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=I}else this._epSquare=I;t.piece===x?this._halfMoves=0:t.flags&(y.CAPTURE|y.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===B&&this._moveNumber++,this._turn=s,this._hash^=Se}undo(){let t=this._hash,e=this._undoMove();if(e){let s=new re(this,e);return this._decPositionCount(t),s}return null}_undoMove(){let t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Se;let s=this._turn,i=ce(s);if(e.flags&y.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&y.EP_CAPTURE){let a;s===B?a=e.to-16:a=e.to+16,this._set(a,{type:x,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(y.KSIDE_CASTLE|y.QSIDE_CASTLE)){let a,n;e.flags&y.KSIDE_CASTLE?(a=e.to+1,n=e.to-1):(a=e.to-2,n=e.to+1),this._movePiece(n,a)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){let s=[],i=!1;for(let p in this._header)this._header[p]&&s.push(`[${p} "${this._header[p]}"]`+t),i=!0;i&&this._history.length&&s.push(t);let a=p=>{let _=this._comments[this.fen()];if(typeof _<"u"){let w=p.length>0?" ":"";p=`${p}${w}{${_}}`}return p},n=[];for(;this._history.length>0;)n.push(this._undoMove());let c=[],u="";for(n.length===0&&c.push(a(""));n.length>0;){u=a(u);let p=n.pop();if(!p)break;if(!this._history.length&&p.color==="b"){let _=`${this._moveNumber}. ...`;u=u?`${u} ${_}`:_}else p.color==="w"&&(u.length&&c.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(p,this._moves({legal:!0})),this._makeMove(p)}if(u.length&&c.push(a(u)),c.push(this._header.Result||"*"),e===0)return s.join("")+c.join(" ");let d=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(p,_){for(let w of _.split(" "))if(w){if(p+w.length>e){for(;d();)p--;s.push(t),p=0}s.push(w),p+=w.length,s.push(" "),p++}return d()&&p--,p},b=0;for(let p=0;p<c.length;p++){if(b+c[p].length>e&&c[p].includes("{")){b=g(b,c[p]);continue}b+c[p].length>e&&p!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),b=0):p!==0&&(s.push(" "),b++),s.push(c[p]),b+=c[p].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Te[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Te[t]||null,!0):!1}getHeaders(){let t={};for(let[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));let i=bs(t);this.reset();let a=i.headers,n="";for(let d in a)d.toLowerCase()==="fen"&&(n=a[d]),this.header(d,a[d]);if(!e)n&&this.load(n,{preserveHeaders:!0});else if(a.SetUp==="1"){if(!("FEN"in a))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(a.FEN,{preserveHeaders:!0})}let c=i.root;for(;c;){if(c.move){let d=this._moveFromSan(c.move,e);if(d==null)throw new Error(`Invalid move in PGN: ${c.move}`);this._makeMove(d),this._incPositionCount()}c.comment!==void 0&&(this._comments[this.fen()]=c.comment),c=c.variations[0]}let u=i.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&y.KSIDE_CASTLE)s="O-O";else if(t.flags&y.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&y.NULL_MOVE)return Ae;if(t.piece!==x){let i=Rs(t,e);s+=t.piece.toUpperCase()+i}t.flags&(y.CAPTURE|y.EP_CAPTURE)&&(t.piece===x&&(s+=T(t.from)[0]),s+="x"),s+=T(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ne(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Ae)return{color:this._turn,from:0,to:0,piece:"k",flags:y.NULL_MOVE};let i=lt(s),a=this._moves({legal:!0,piece:i});for(let p=0,_=a.length;p<_;p++)if(s===Ne(this._moveToSan(a[p],a)))return a[p];if(e)return null;let n,c,u,d,g,b=!1;if(c=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),c?(n=c[1],u=c[2],d=c[3],g=c[4],u.length==1&&(b=!0)):(c=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),c&&(n=c[1],u=c[2],d=c[3],g=c[4],u.length==1&&(b=!0))),i=lt(s),a=this._moves({legal:!0,piece:n||i}),!d)return null;for(let p=0,_=a.length;p<_;p++)if(u){if((!n||n.toLowerCase()==a[p].piece)&&C[u]==a[p].from&&C[d]==a[p].to&&(!g||g.toLowerCase()==a[p].promotion))return a[p];if(b){let w=T(a[p].from);if((!n||n.toLowerCase()==a[p].piece)&&C[d]==a[p].to&&(u==w[0]||u==w[1])&&(!g||g.toLowerCase()==a[p].promotion))return a[p]}}else if(s===Ne(this._moveToSan(a[p],a)).replace("x",""))return a[p];return null}ascii(){let t=`   +------------------------+
`;for(let e=C.a8;e<=C.h1;e++){if(fe(e)===0&&(t+=" "+"87654321"[te(e)]+" |"),this._board[e]){let s=this._board[e].type,a=this._board[e].color===R?s.toUpperCase():s.toLowerCase();t+=" "+a+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){let e=this._moves({legal:!1}),s=0,i=this._turn;for(let a=0,n=e.length;a<n;a++)this._makeMove(e[a]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],e=[];for(let s=C.a8;s<=C.h1;s++)this._board[s]==null?e.push(null):e.push({square:T(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in C){let e=C[t];return(te(e)+fe(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){let e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){let i=e.pop();if(!i)break;t?s.push(new re(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){let t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){let i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(let i of[A,V])e[i]!==void 0&&(e[i]?this._castling[t]|=me[i]:this._castling[t]&=~me[i]);this._updateCastlingRights();let s=this.getCastlingRights(t);return(e[A]===void 0||e[A]===s[A])&&(e[V]===void 0||e[V]===s[V])}getCastlingRights(t){return{[A]:(this._castling[t]&me[A])!==0,[V]:(this._castling[t]&me[V])!==0}}moveNumber(){return this._moveNumber}};var Ls=(r=Ke)=>({headers:r(),moves:new ke}),ke=class{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){let e=t.children[0];yield e,t=e}}*mainline(){for(let t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}},Oe=class extends ke{constructor(t){super(),this.data=t}};var Ks=r=>r?r.winner==="white"?"1-0":r.winner==="black"?"0-1":"1/2-1/2":"*",Fs=r=>r==="1-0"||r==="1\u20130"||r==="1\u20140"?{winner:"white"}:r==="0-1"||r==="0\u20131"||r==="0\u20141"?{winner:"black"}:r==="1/2-1/2"||r==="1/2\u20131/2"||r==="1/2\u20141/2"?{winner:void 0}:void 0;var Ke=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]);var ht="\uFEFF",Me=r=>/^\s*$/.test(r),Ie=r=>r.startsWith("%"),Re=class extends Error{},Le=class{constructor(t,e=Ke,s=1e6){this.emitGame=t,this.initHeaders=e,this.maxBudget=s,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Ls(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Re("ERR_PGN_BUDGET")}parse(t,e){if(!(this.budget<0))try{let s=0;for(;;){let i=t.indexOf(`
`,s);if(i===-1)break;let a=i>s&&t[i-1]==="\r"?i-1:i;this.consumeBudget(i-s),this.lineBuf.push(t.slice(s,a)),s=i+1,this.handleLine()}this.consumeBudget(t.length-s),this.lineBuf.push(t.slice(s)),e?.stream||(this.handleLine(),this.emit(void 0))}catch(s){this.emit(s)}}handleLine(){let t=!0,e=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:e.startsWith(ht)&&(e=e.slice(ht.length)),this.state=1;case 1:if(Me(e)||Ie(e))return;this.found=!0,this.state=2;case 2:{if(Ie(e))return;let s=!0;for(;s;)s=!1,e=e.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(i,a,n)=>(this.consumeBudget(200),this.handleHeader(a,n.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),s=!0,t=!1,""));if(Me(e))return;this.state=3}case 3:{if(t){if(Ie(e))return;if(Me(e))return this.emit(void 0)}let s=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g,i;for(;i=s.exec(e);){let a=this.stack[this.stack.length-1],n=i[0];if(n===";")return;if(n.startsWith("$"))this.handleNag(parseInt(n.slice(1),10));else if(n==="!")this.handleNag(1);else if(n==="?")this.handleNag(2);else if(n==="!!")this.handleNag(3);else if(n==="??")this.handleNag(4);else if(n==="!?")this.handleNag(5);else if(n==="?!")this.handleNag(6);else if(n==="1-0"||n==="1\u20130"||n==="1\u20140"||n==="0-1"||n==="0\u20131"||n==="0\u20141"||n==="1/2-1/2"||n==="1/2\u20131/2"||n==="1/2\u20141/2"||n==="*")this.stack.length===1&&n!=="*"&&this.handleHeader("Result",n);else if(n==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(n===")")this.stack.length>1&&this.stack.pop();else if(n==="{"){let c=s.lastIndex,u=e[c]===" "?c+1:c;e=e.slice(u),this.state=4;continue e}else this.consumeBudget(100),n.startsWith("O")||n.startsWith("0")||n.startsWith("o")?n=n.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(n==="Z0"||n==="0000"||n==="@@@@")&&(n="--"),a.node&&(a.parent=a.node),a.node=new Oe({san:n,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{let s=e.indexOf("}");if(s===-1){this.commentBuf.push(e);return}else{let i=s>0&&e[s-1]===" "?s-1:s;this.commentBuf.push(e.slice(0,i)),this.handleComment(),e=e.slice(s),this.state=3,t=!1}}}}handleHeader(t,e){this.game.headers.set(t,t==="Result"?Ks(Fs(e)):e)}handleNag(t){var e;this.consumeBudget(50);let s=this.stack[this.stack.length-1];s.node&&((e=s.node.data).nags||(e.nags=[]),s.node.data.nags.push(t))}handleComment(){var t,e;this.consumeBudget(100);let s=this.stack[this.stack.length-1],i=this.commentBuf.join(`
`);this.commentBuf=[],s.node?((t=s.node.data).comments||(t.comments=[]),s.node.data.comments.push(i)):s.root?((e=this.game).comments||(e.comments=[]),this.game.comments.push(i)):(s.startingComments||(s.startingComments=[]),s.startingComments.push(i))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}},ft=(r,t=Ke)=>{let e=[];return new Le(s=>e.push(s),t,NaN).parse(r),e};var z=[],H=[],ue=new Map;addEventListener("message",({data:r})=>{try{switch(r.type){case"load":Bs(r.payload,r.id);break;case"filter":qs(r.payload,r.id);break;case"loadGame":Ds(r.payload,r.id);break}}catch(t){postMessage({type:"error",payload:String(t),id:r.id})}});function Bs(r,t){z=[],H=[],ue.clear(),z=Us(r).filter(s=>{let i=s.match(/\[Variant\s+"([^"]+)"\]/);return i?i[1]==="Standard":!0}),H=z.map((s,i)=>Gs(s,i)),postMessage({type:"load",id:t,payload:{count:z.length,metadata:H}})}function ut(r){let t=r.toLowerCase();return t.includes("\xBD")||t.includes("1/2")?"draw":t.includes("1-0")?"1-0":t.includes("0-1")?"0-1":t}function qs(r,t){let{white:e,black:s,result:i,moves:a,ignoreColor:n,targetMoves:c,minWhiteRating:u,minBlackRating:d,maxWhiteRating:g,maxBlackRating:b,eco:p}=r,_=e.toLowerCase(),w=s.toLowerCase(),S=i.toLowerCase(),M=p.toLowerCase();a&&c.length>0&&ue.clear();let Y=[];for(let K=0;K<z.length;K++){let N=H[K],G=N.white.toLowerCase(),Z=N.black.toLowerCase(),se=!0,oe=!0;if(n?(_&&!(G.includes(_)||Z.includes(_))&&(se=!1),w&&!(G.includes(w)||Z.includes(w))&&(oe=!1)):(_&&!G.includes(_)&&(se=!1),w&&!Z.includes(w)&&(oe=!1)),!(!se||!oe)&&!(S&&!ut(N.result).includes(ut(i)))&&!(M&&(!N.eco||!N.eco.toLowerCase().includes(M)))){if(n){let F=0;if(u>0&&d>0?F=Math.min(u,d):u>0?F=u:d>0&&(F=d),F>0&&(N.whiteElo<F||N.blackElo<F))continue;let O=0;if(g>0&&b>0?O=Math.max(g,b):g>0?O=g:b>0&&(O=b),O>0&&(N.whiteElo>O||N.blackElo>O))continue}else if(u>0&&N.whiteElo<u||d>0&&N.blackElo<d||g>0&&N.whiteElo>g||b>0&&N.blackElo>b)continue;if(a&&c.length>0){let F=z[K];if(!F.includes(c[0]))continue;let O=ue.get(K);if(O||(O=Qs(F),ue.set(K,O)),!O)continue;let Q=!0;if(c.length>O.length)Q=!1;else for(let J=0;J<c.length;J++)if(O[J]!==c[J]){Q=!1;break}if(!Q)continue}Y.push(K)}}Y.sort((K,N)=>{let G=H[K].whiteElo+H[K].blackElo;return H[N].whiteElo+H[N].blackElo-G}),postMessage({type:"filter",id:t,payload:Y})}function Ds(r,t){if(r<0||r>=z.length)throw new Error("Game index out of bounds");let e=z[r],s=[],i=[],a,n=e;try{let c=new ae;try{c.loadPgn(e),s=c.history();let u=c.getComments(),d=new ae;i=s.map(g=>{d.move(g);let b=d.fen(),p=u.find(_=>_.fen===b);if(p){let _=p.comment.match(/\[%eval\s+([^\]]+)\]/);return _?_[1]:null}return null})}catch{n=n.replace(/([a-h1-8NBRQK])([?!]+)/g,"$1"),n=n.replace(/\}\s*\{/g," "),n=n.replace(/\]\s*\[/g,`]
[`),n=n.replace(/\]\s*(\d+\.|[a-hNBRQK]|\*|1-0|0-1|1\/2-1\/2)/g,`]

$1`),n=n.replace(/\d+\.\.\./g," "),n=n.replace(/\$\d+/g,"");try{c.loadPgn(n),s=c.history();let d=c.getComments(),g=new ae;i=s.map(b=>{g.move(b);let p=g.fen(),_=d.find(w=>w.fen===p);if(_){let w=_.comment.match(/\[%eval\s+([^\]]+)\]/);return w?w[1]:null}return null})}catch{try{let g=ft(n);if(g.length>0){let b=g[0];s=[],i=[];let p=b.moves;for(;p.children.length>0;){let _=p.children[0];if(_.data?.san){s.push(_.data.san);let w=null;if(_.data.comments)for(let S of _.data.comments){let M=S.match(/\[%eval\s+([^\]]+)\]/);if(M){w=M[1];break}}i.push(w)}p=_}a=void 0}else throw new Error("Chessops found no games")}catch{n=n.replace(/\{[^}]*\}/g,""),n=n.replace(/\([^)]*\)/g,""),n=n.replace(/\s+/g," "),c.loadPgn(n),s=c.history(),i=[],a=void 0}}}ue.set(r,s)}catch(c){console.error("Error parsing game moves",c),a=String(c),s=[],i=[]}postMessage({type:"loadGame",id:t,payload:{moves:s,pgn:n,evaluations:i,error:a}})}function Us(r){let t=r.split(/(?=\[Event\s+")/),e=[];for(let s of t){let i=s.trim();i.length>0&&/^\[Event\s+"/.test(i)&&e.push(i)}return e}function Gs(r,t){let e=r.match(/\[White\s+"([^"]+)"\]/),s=r.match(/\[Black\s+"([^"]+)"\]/),i=r.match(/\[Result\s+"([^"]+)"\]/),a=r.match(/\[WhiteElo\s+"([^"]+)"\]/),n=r.match(/\[BlackElo\s+"([^"]+)"\]/),c=r.match(/\[WhiteTitle\s+"([^"]+)"\]/),u=r.match(/\[BlackTitle\s+"([^"]+)"\]/),d=r.match(/\[ECO\s+"([^"]+)"\]/),g=e?e[1]:"Unknown",b=s?s[1]:"Unknown",p=i?i[1]:"*";c&&(g=`${c[1]} ${g}`),a&&(g=`${g} (${a[1]})`),u&&(b=`${u[1]} ${b}`),n&&(b=`${b} (${n[1]})`);let _=p;p==="1-0"?_="1-0":p==="0-1"?_="0-1":p==="1/2-1/2"&&(_="\xBD-\xBD");let w=a&&parseInt(a[1],10)||0,S=n&&parseInt(n[1],10)||0,M=d?d[1]:void 0;return{number:t+1,white:g,black:b,result:_,whiteElo:w,blackElo:S,eco:M}}function Qs(r){let t=r;if(r.startsWith("[")){let i=0,a=!1;for(;i<r.length;){let n=r.indexOf(`
`,i),c=n===-1?r.length:n,g=r.slice(i,c).replace(/\r$/,"").trim();if(g.startsWith("[")&&g.endsWith("]")){a=!0,i=n===-1?r.length:n+1;continue}if(a&&g.length===0){t=r.slice(n===-1?r.length:n+1);break}t=r.slice(i);break}}return t=t.replace(/\{[^}]*\}/g," "),t=t.replace(/\([^)]*\)/g," "),t=t.replace(/;.*$/gm," "),t=t.replace(/\d+\.+/g," "),t=t.replace(/(1-0|0-1|1\/2-1\/2|\*)/g," "),t=t.replace(/\$\d+/g," "),t.trim().split(/\s+/).filter(i=>i.length>0&&i!==".").map(i=>i.replace(/[!?]+$/g,"")).filter(i=>!i||/^[{}()\[\]]/.test(i)?!1:/^([NBRQK]?[a-h]?[1-8]?x?[a-h][1-8](=[NBRQ])?|O-O(-O)?)[+#]?$/.test(i))}
