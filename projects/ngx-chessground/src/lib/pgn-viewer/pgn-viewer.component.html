<div class="container">
    <div class="viewer-layout">
        <div class="board-container">
            <ngx-chessground [runFunction]="runFunction()"></ngx-chessground>
            @if (games().length > 0) {
            <div class="game-info-display">
                <div class="players">{{ currentWhitePlayer() }} vs {{ currentBlackPlayer() }}</div>
                <div class="result">{{ currentGameResult() }}</div>
            </div>
            } @else {
            <div class="game-info-display">
                <div class="players">No game loaded</div>
                <div class="result">-</div>
            </div>
            }
        </div>

        <div class="controls-container">
            <!-- File Loading -->
            <div class="zip-loader">
                <div>
                    <label>Load PGN Zip:
                        <input type="file" accept=".zip" (change)="onPgnZipSelected($event)" [disabled]="isLoading()">
                    </label>
                </div>
                <div>
                    <label>Load PGN File:
                        <input type="file" accept=".pgn" (change)="onPgnFileSelected($event)" [disabled]="isLoading()">
                    </label>
                </div>
                @if (isLoading()) {
                <div class="loading-indicator">
                    ‚è≥ Loading and parsing file...
                </div>
                }
            </div>

            <!-- Game Navigation (if multiple games) -->
            @if (games().length > 1) {
            <div class="game-navigation">
                <button (click)="prevGame()" [disabled]="currentGameIndex() === 0">Prev Game</button>
                <button (click)="nextGame()" [disabled]="currentGameIndex() === games().length - 1">Next Game</button>
            </div>

            <!-- Game Selection -->
            <div class="game-selection">
                <h3>Game Selection</h3>
                <div class="selection-controls">
                    <button (click)="selectAllGames()">Select All</button>
                    <button (click)="clearSelection()">Clear All</button>
                    <span>Selected: {{ selectedGamesCount() }} of {{ games().length }}</span>
                </div>
                <div class="game-list">
                    @for (gameInfo of gameInfos(); track gameInfo.number) {
                    <div class="game-item">
                        <label>
                            <input type="checkbox"
                                   [checked]="selectedGames().has(gameInfo.number - 1)"
                                   (change)="toggleGameSelection(gameInfo.number - 1)">
                            <div class="game-info">
                                <div class="players">{{ gameInfo.white }} vs {{ gameInfo.black }}</div>
                                <div class="result">{{ gameInfo.result }}</div>
                            </div>
                        </label>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Move Navigation -->
            <div class="navigation">
                <button (click)="start()" [disabled]="currentMoveIndex() === -1">&lt;&lt;</button>
                <button (click)="prev()" [disabled]="currentMoveIndex() === -1">&lt;</button>
                <button (click)="next()" [disabled]="currentMoveIndex() >= moves().length - 1">&gt;</button>
                <button (click)="end()" [disabled]="currentMoveIndex() >= moves().length - 1">&gt;&gt;</button>
            </div>

            <div class="status">
                Move: {{ currentMoveIndex() + 1 }} / {{ moves().length }}
            </div>

            <!-- Replay Controls -->
            <div class="replay-controls">
                <h3>Replay Options</h3>
                <div class="mode-selection">
                    <label><input type="radio" name="mode" [value]="'realtime'"
                            [checked]="replayMode() === 'realtime'"
                            (change)="replayMode.set('realtime')"> Real Time</label>
                    <label><input type="radio" name="mode" [value]="'proportional'"
                            [checked]="replayMode() === 'proportional'"
                            (change)="replayMode.set('proportional')"> Proportional</label>
                    <label><input type="radio" name="mode" [value]="'fixed'"
                            [checked]="replayMode() === 'fixed'"
                            (change)="replayMode.set('fixed')"> Fixed Time</label>
                </div>

                @if (replayMode() === 'proportional') {
                <div class="option-input">
                    <label>Duration (min): <input type="number" [value]="proportionalDuration()"
                            (input)="onProportionalDurationChange($event)" step="0.1"></label>
                </div>
                }

                @if (replayMode() === 'fixed') {
                <div class="option-input">
                    <label>Time per move (sec): <input type="number" [value]="fixedTime()"
                            (input)="onFixedTimeChange($event)" step="0.1"></label>
                </div>
                }

                <div class="replay-buttons">
                    <button (click)="replayGame()">Replay Game</button>
                    @if (canShowReplayAll()) {
                    <button (click)="replayAllSelectedGames()">Replay All Selected ({{ selectedGamesCount() }})</button>
                    }
                    <button (click)="stopReplay()">Stop</button>
                </div>
            </div>

            <!-- Manual PGN Input -->
            <div class="pgn-input">
                <textarea [value]="pgnInput()" (input)="onPgnInputChange($event)" rows="15"
                    placeholder="Paste PGN here"></textarea>
                <button (click)="loadPgnFromInput()">Load PGN</button>
            </div>
        </div>
    </div>
    
</div>