function us(n){return n!==null?{comment:n,variations:[]}:{variations:[]}}function ps(n,t,e,s,i){let r={move:n,variations:i};return t&&(r.suffix=t),e&&(r.nag=e),s!==null&&(r.comment=s),r}function ds(...n){let[t,...e]=n,s=t;for(let i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function gs(n,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){let s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:n,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function ms(n,t){function e(){this.constructor=n}e.prototype=t.prototype,n.prototype=new e}function X(n,t,e,s){var i=Error.call(this,n);return Object.setPrototypeOf&&Object.setPrototypeOf(i,X.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}ms(X,Error);function ve(n,t,e){return e=e||" ",n.length>t?n:(t-=n.length,e+=e.repeat(t),n+e.slice(0,t))}X.prototype.format=function(n){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<n.length;s++)if(n[s].source===this.location.source){e=n[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,o=this.location.source+":"+r.line+":"+r.column;if(e){var f=this.location.end,u=ve("",r.line.toString().length," "),d=e[i.line-1],m=i.line===f.line?f.column:d.length+1,k=m-i.column||1;t+=`
 --> `+o+`
`+u+` |
`+r.line+" | "+d+`
`+u+" | "+ve("",i.column-1," ")+ve("",k,"^")}else t+=`
 at `+o}return t};X.buildMessage=function(n,t){var e={literal:function(d){return'"'+i(d.text)+'"'},class:function(d){var m=d.parts.map(function(k){return Array.isArray(k)?r(k[0])+"-"+r(k[1]):r(k)});return"["+(d.inverted?"^":"")+m.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(d){return d.description}};function s(d){return d.charCodeAt(0).toString(16).toUpperCase()}function i(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(m){return"\\x0"+s(m)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(m){return"\\x"+s(m)})}function r(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(m){return"\\x0"+s(m)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(m){return"\\x"+s(m)})}function o(d){return e[d.type](d)}function f(d){var m=d.map(o),k,p;if(m.sort(),m.length>0){for(k=1,p=1;k<m.length;k++)m[k-1]!==m[k]&&(m[p]=m[k],p++);m.length=p}switch(m.length){case 1:return m[0];case 2:return m[0]+" or "+m[1];default:return m.slice(0,-1).join(", ")+", or "+m[m.length-1]}}function u(d){return d?'"'+i(d)+'"':"end of input"}return"Expected "+f(n)+" but "+u(t)+" found."};function _s(n,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:Je},r=Je,o="[",f='"',u="]",d=".",m="O-O-O",k="O-O",p="0-0-0",b="0-0",S="$",$="{",O="}",Q=";",z="(",q=")",Y="1-0",H="0-1",Oe="1/2-1/2",ft="*",me=/^[a-zA-Z]/,Le=/^[^"]/,re=/^[0-9]/,Re=/^[.]/,Ke=/^[a-zA-Z1-8\-=]/,ut=/^[+#]/,Fe=/^[!?]/,qe=/^[^}]/,Be=/^[^\r\n]/,De=/^[ \t\r\n]/,pt=R("tag pair"),dt=N("[",!1),Ue=N('"',!1),gt=N("]",!1),mt=R("tag name"),_e=F([["a","z"],["A","Z"]],!1,!1),_t=R("tag value"),Ge=F(['"'],!0,!1),bt=R("move number"),ne=F([["0","9"]],!1,!1),vt=N(".",!1),Qe=F(["."],!1,!1),kt=R("standard algebraic notation"),Et=N("O-O-O",!1),Ct=N("O-O",!1),yt=N("0-0-0",!1),St=N("0-0",!1),He=F([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),wt=F(["+","#"],!1,!1),$t=R("suffix annotation"),Ve=F(["!","?"],!1,!1),xt=R("NAG"),At=N("$",!1),Nt=R("brace comment"),Pt=N("{",!1),je=F(["}"],!0,!1),Tt=N("}",!1),It=R("rest of line comment"),Mt=N(";",!1),We=F(["\r",`
`],!0,!1),Ot=R("variation"),Lt=N("(",!1),Rt=N(")",!1),Kt=R("game termination marker"),Ft=N("1-0",!1),qt=N("0-1",!1),Bt=N("1/2-1/2",!1),Dt=N("*",!1),Ut=R("whitespace"),ze=F([" ","	","\r",`
`],!1,!1),Gt=function(a,c){return gs(a,c)},Qt=function(a){return Object.fromEntries(a)},Ht=function(a,c){return[a,c]},Vt=function(a,c){return{root:a,marker:c}},jt=function(a,c){return ds(us(a),...c.flat())},Wt=function(a,c,h,v,E){return ps(a,c,h,v,E)},zt=function(a){return a},Yt=function(a){return a.replace(/[\r\n]+/g," ")},Zt=function(a){return a.trim()},Jt=function(a){return a},Xt=function(a,c){return{result:a,comment:c}},l=t.peg$currPos|0,Z=[{line:1,column:1}],K=l,ae=t.peg$maxFailExpected||[],g=t.peg$silentFails|0,ee;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');r=i[t.startRule]}function N(a,c){return{type:"literal",text:a,ignoreCase:c}}function F(a,c,h){return{type:"class",parts:a,inverted:c,ignoreCase:h}}function es(){return{type:"end"}}function R(a){return{type:"other",description:a}}function Ye(a){var c=Z[a],h;if(c)return c;if(a>=Z.length)h=Z.length-1;else for(h=a;!Z[--h];);for(c=Z[h],c={line:c.line,column:c.column};h<a;)n.charCodeAt(h)===10?(c.line++,c.column=1):c.column++,h++;return Z[a]=c,c}function Ze(a,c,h){var v=Ye(a),E=Ye(c),w={source:s,start:{offset:a,line:v.line,column:v.column},end:{offset:c,line:E.line,column:E.column}};return w}function _(a){l<K||(l>K&&(K=l,ae=[]),ae.push(a))}function ts(a,c,h){return new X(X.buildMessage(a,c),a,c,h)}function Je(){var a,c,h;return a=l,c=ss(),h=ns(),a=Gt(c,h),a}function ss(){var a,c,h;for(a=l,c=[],h=Xe();h!==e;)c.push(h),h=Xe();return h=M(),a=Qt(c),a}function Xe(){var a,c,h,v,E,w,V;return g++,a=l,M(),n.charCodeAt(l)===91?(c=o,l++):(c=e,g===0&&_(dt)),c!==e?(M(),h=is(),h!==e?(M(),n.charCodeAt(l)===34?(v=f,l++):(v=e,g===0&&_(Ue)),v!==e?(E=rs(),n.charCodeAt(l)===34?(w=f,l++):(w=e,g===0&&_(Ue)),w!==e?(M(),n.charCodeAt(l)===93?(V=u,l++):(V=e,g===0&&_(gt)),V!==e?a=Ht(h,E):(l=a,a=e)):(l=a,a=e)):(l=a,a=e)):(l=a,a=e)):(l=a,a=e),g--,a===e&&g===0&&_(pt),a}function is(){var a,c,h;if(g++,a=l,c=[],h=n.charAt(l),me.test(h)?l++:(h=e,g===0&&_(_e)),h!==e)for(;h!==e;)c.push(h),h=n.charAt(l),me.test(h)?l++:(h=e,g===0&&_(_e));else c=e;return c!==e?a=n.substring(a,l):a=c,g--,a===e&&(c=e,g===0&&_(mt)),a}function rs(){var a,c,h;for(g++,a=l,c=[],h=n.charAt(l),Le.test(h)?l++:(h=e,g===0&&_(Ge));h!==e;)c.push(h),h=n.charAt(l),Le.test(h)?l++:(h=e,g===0&&_(Ge));return a=n.substring(a,l),g--,c=e,g===0&&_(_t),a}function ns(){var a,c,h;return a=l,c=et(),M(),h=fs(),h===e&&(h=null),M(),a=Vt(c,h),a}function et(){var a,c,h,v;for(a=l,c=be(),c===e&&(c=null),h=[],v=tt();v!==e;)h.push(v),v=tt();return a=jt(c,h),a}function tt(){var a,c,h,v,E,w,V,oe;if(a=l,M(),as(),M(),c=os(),c!==e){for(h=ls(),h===e&&(h=null),v=[],E=st();E!==e;)v.push(E),E=st();for(E=M(),w=be(),w===e&&(w=null),V=[],oe=it();oe!==e;)V.push(oe),oe=it();a=Wt(c,h,v,w,V)}else l=a,a=e;return a}function as(){var a,c,h,v,E,w;for(g++,a=l,c=[],h=n.charAt(l),re.test(h)?l++:(h=e,g===0&&_(ne));h!==e;)c.push(h),h=n.charAt(l),re.test(h)?l++:(h=e,g===0&&_(ne));if(n.charCodeAt(l)===46?(h=d,l++):(h=e,g===0&&_(vt)),h!==e){for(v=M(),E=[],w=n.charAt(l),Re.test(w)?l++:(w=e,g===0&&_(Qe));w!==e;)E.push(w),w=n.charAt(l),Re.test(w)?l++:(w=e,g===0&&_(Qe));c=[c,h,v,E],a=c}else l=a,a=e;return g--,a===e&&(c=e,g===0&&_(bt)),a}function os(){var a,c,h,v,E,w;if(g++,a=l,c=l,n.substr(l,5)===m?(h=m,l+=5):(h=e,g===0&&_(Et)),h===e&&(n.substr(l,3)===k?(h=k,l+=3):(h=e,g===0&&_(Ct)),h===e&&(n.substr(l,5)===p?(h=p,l+=5):(h=e,g===0&&_(yt)),h===e&&(n.substr(l,3)===b?(h=b,l+=3):(h=e,g===0&&_(St)),h===e))))if(h=l,v=n.charAt(l),me.test(v)?l++:(v=e,g===0&&_(_e)),v!==e){if(E=[],w=n.charAt(l),Ke.test(w)?l++:(w=e,g===0&&_(He)),w!==e)for(;w!==e;)E.push(w),w=n.charAt(l),Ke.test(w)?l++:(w=e,g===0&&_(He));else E=e;E!==e?(v=[v,E],h=v):(l=h,h=e)}else l=h,h=e;return h!==e?(v=n.charAt(l),ut.test(v)?l++:(v=e,g===0&&_(wt)),v===e&&(v=null),h=[h,v],c=h):(l=c,c=e),c!==e?a=n.substring(a,l):a=c,g--,a===e&&(c=e,g===0&&_(kt)),a}function ls(){var a,c,h;for(g++,a=l,c=[],h=n.charAt(l),Fe.test(h)?l++:(h=e,g===0&&_(Ve));h!==e;)c.push(h),c.length>=2?h=e:(h=n.charAt(l),Fe.test(h)?l++:(h=e,g===0&&_(Ve)));return c.length<1?(l=a,a=e):a=c,g--,a===e&&(c=e,g===0&&_($t)),a}function st(){var a,c,h,v,E;if(g++,a=l,M(),n.charCodeAt(l)===36?(c=S,l++):(c=e,g===0&&_(At)),c!==e){if(h=l,v=[],E=n.charAt(l),re.test(E)?l++:(E=e,g===0&&_(ne)),E!==e)for(;E!==e;)v.push(E),E=n.charAt(l),re.test(E)?l++:(E=e,g===0&&_(ne));else v=e;v!==e?h=n.substring(h,l):h=v,h!==e?a=zt(h):(l=a,a=e)}else l=a,a=e;return g--,a===e&&g===0&&_(xt),a}function be(){var a;return a=cs(),a===e&&(a=hs()),a}function cs(){var a,c,h,v,E;if(g++,a=l,n.charCodeAt(l)===123?(c=$,l++):(c=e,g===0&&_(Pt)),c!==e){for(h=l,v=[],E=n.charAt(l),qe.test(E)?l++:(E=e,g===0&&_(je));E!==e;)v.push(E),E=n.charAt(l),qe.test(E)?l++:(E=e,g===0&&_(je));h=n.substring(h,l),n.charCodeAt(l)===125?(v=O,l++):(v=e,g===0&&_(Tt)),v!==e?a=Yt(h):(l=a,a=e)}else l=a,a=e;return g--,a===e&&(c=e,g===0&&_(Nt)),a}function hs(){var a,c,h,v,E;if(g++,a=l,n.charCodeAt(l)===59?(c=Q,l++):(c=e,g===0&&_(Mt)),c!==e){for(h=l,v=[],E=n.charAt(l),Be.test(E)?l++:(E=e,g===0&&_(We));E!==e;)v.push(E),E=n.charAt(l),Be.test(E)?l++:(E=e,g===0&&_(We));h=n.substring(h,l),a=Zt(h)}else l=a,a=e;return g--,a===e&&(c=e,g===0&&_(It)),a}function it(){var a,c,h,v;return g++,a=l,M(),n.charCodeAt(l)===40?(c=z,l++):(c=e,g===0&&_(Lt)),c!==e?(h=et(),h!==e?(M(),n.charCodeAt(l)===41?(v=q,l++):(v=e,g===0&&_(Rt)),v!==e?a=Jt(h):(l=a,a=e)):(l=a,a=e)):(l=a,a=e),g--,a===e&&g===0&&_(Ot),a}function fs(){var a,c,h;return g++,a=l,n.substr(l,3)===Y?(c=Y,l+=3):(c=e,g===0&&_(Ft)),c===e&&(n.substr(l,3)===H?(c=H,l+=3):(c=e,g===0&&_(qt)),c===e&&(n.substr(l,7)===Oe?(c=Oe,l+=7):(c=e,g===0&&_(Bt)),c===e&&(n.charCodeAt(l)===42?(c=ft,l++):(c=e,g===0&&_(Dt))))),c!==e?(M(),h=be(),h===e&&(h=null),a=Xt(c,h)):(l=a,a=e),g--,a===e&&(c=e,g===0&&_(Kt)),a}function M(){var a,c;for(g++,a=[],c=n.charAt(l),De.test(c)?l++:(c=e,g===0&&_(ze));c!==e;)a.push(c),c=n.charAt(l),De.test(c)?l++:(c=e,g===0&&_(ze));return g--,c=e,g===0&&_(Ut),a}if(ee=r(),t.peg$library)return{peg$result:ee,peg$currPos:l,peg$FAILED:e,peg$maxFailExpected:ae,peg$maxFailPos:K};if(ee!==e&&l===n.length)return ee;throw ee!==e&&l<n.length&&_(es()),ts(ae,K<n.length?n.charAt(K):null,K<n.length?Ze(K,K+1):Ze(K,K))}var ce=0xffffffffffffffffn;function ke(n,t){return(n<<t|n>>64n-t)&0xffffffffffffffffn}function rt(n,t){return n*t&ce}function bs(n){return function(){let t=BigInt(n&ce),e=BigInt(n>>64n&ce),s=rt(ke(rt(t,5n),7n),9n);return e^=t,t=(ke(t,24n)^e^e<<16n)&ce,e=ke(e,37n),n=e<<64n|t,s}}var ue=bs(0xa187eb39cdcaed8f31c4b365b102e01en),vs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ue()))),ks=Array.from({length:8},()=>ue()),Es=Array.from({length:16},()=>ue()),Ee=ue(),I="w",L="b",x="p",$e="n",he="b",se="r",U="q",A="k",Ce="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",J=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){let{color:s,piece:i,from:r,to:o,flags:f,captured:u,promotion:d}=e,m=P(r),k=P(o);this.color=s,this.piece=i,this.from=m,this.to=k,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=m+k,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(let p in y)y[p]&f&&(this.flags+=j[p]);u&&(this.captured=u),d&&(this.promotion=d,this.lan+=d)}isCapture(){return this.flags.indexOf(j.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(j.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(j.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(j.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(j.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(j.BIG_PAWN)>-1}},T=-1,j={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"};var y={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},xe={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Cs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},ys={...xe,...Cs},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ye={b:[16,32,17,15],w:[-16,-32,-17,-15]},nt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ss=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ws=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],$s={p:1,n:2,b:4,r:8,q:16,k:32},xs="pnbrqkPNBRQK",at=[$e,he,se,U],As=7,Ns=6,Ps=1,Ts=0,le={[A]:y.KSIDE_CASTLE,[U]:y.QSIDE_CASTLE},B={w:[{square:C.a1,flag:y.QSIDE_CASTLE},{square:C.h1,flag:y.KSIDE_CASTLE}],b:[{square:C.a8,flag:y.QSIDE_CASTLE},{square:C.h8,flag:y.KSIDE_CASTLE}]},Is={b:Ps,w:Ns},Se="--";function W(n){return n>>4}function ie(n){return n&15}function lt(n){return"0123456789".indexOf(n)!==-1}function P(n){let t=ie(n),e=W(n);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function te(n){return n===I?L:I}function Ms(n){let t=n.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let o=0;o<i.length;o++){let f=0,u=!1;for(let d=0;d<i[o].length;d++)if(lt(i[o][d])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};f+=parseInt(i[o][d],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[o][d]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};f+=1,u=!1}if(f!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:o,regex:f}of r){if(!f.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${o} king`};if((t[0].match(f)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${o} kings`}}return Array.from(i[0]+i[7]).some(o=>o.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Os(n,t){let e=n.from,s=n.to,i=n.piece,r=0,o=0,f=0;for(let u=0,d=t.length;u<d;u++){let m=t[u].from,k=t[u].to,p=t[u].piece;i===p&&e!==m&&s===k&&(r++,W(e)===W(m)&&o++,ie(e)===ie(m)&&f++)}return r>0?o>0&&f>0?P(e):f>0?P(e).charAt(1):P(e).charAt(0):""}function D(n,t,e,s,i,r=void 0,o=y.NORMAL){let f=W(s);if(i===x&&(f===As||f===Ts))for(let u=0;u<at.length;u++){let d=at[u];n.push({color:t,from:e,to:s,piece:i,captured:r,promotion:d,flags:o|y.PROMOTION})}else n.push({color:t,from:e,to:s,piece:i,captured:r,flags:o})}function ot(n){let t=n.charAt(0);return t>="a"&&t<="h"?n.match(/[a-h]\d.*[a-h]\d/)?void 0:x:(t=t.toLowerCase(),t==="o"?A:t)}function we(n){return n.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var fe=class{_board=new Array(128);_turn=I;_header={};_kings={w:T,b:T};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=Ce,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:T,b:T},this._turn=I,this._castling={w:0,b:0},this._epSquare=T,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...ys},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){let f=["-","-","0","1"];t=i.concat(f.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){let{ok:f,error:u}=Ms(t);if(!f)throw new Error(u)}let r=i[0],o=0;this.clear({preserveHeaders:s});for(let f=0;f<r.length;f++){let u=r.charAt(f);if(u==="/")o+=8;else if(lt(u))o+=parseInt(u,10);else{let d=u<"a"?I:L;this._put({type:u.toLowerCase(),color:d},P(o)),o++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=y.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=y.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=y.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=y.QSIDE_CASTLE),this._epSquare=i[3]==="-"?T:C[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let o=C.a8;o<=C.h1;o++){if(this._board[o]){e>0&&(s+=e,e=0);let{color:f,type:u}=this._board[o];s+=f===I?u.toUpperCase():u.toLowerCase()}else e++;o+1&136&&(e>0&&(s+=e),o!==C.h1&&(s+="/"),e=0,o+=8)}let i="";this._castling[I]&y.KSIDE_CASTLE&&(i+="K"),this._castling[I]&y.QSIDE_CASTLE&&(i+="Q"),this._castling[L]&y.KSIDE_CASTLE&&(i+="k"),this._castling[L]&y.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==T)if(t)r=P(this._epSquare);else{let o=this._epSquare+(this._turn===I?16:-16),f=[o+1,o-1];for(let u of f){if(u&136)continue;let d=this._turn;if(this._board[u]?.color===d&&this._board[u]?.type===x){this._makeMove({color:d,from:u,to:this._epSquare,piece:x,captured:x,flags:y.EP_CAPTURE});let m=!this._isKingAttacked(d);if(this._undoMove(),m){r=P(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:e,type:s}=this._board[t],i={w:0,b:1}[e],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return vs[i][r][t]}_epKey(){return this._epSquare===T?0n:ks[this._epSquare&7]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return Es[t]}_computeHash(){let t=0n;for(let e=C.a8;e<=C.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Ee),t}_updateSetup(t){this._history.length>0||(t!==Ce?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Ce)}get(t){return this._board[C[t]]}findPiece(t){let e=[];for(let s=C.a8;s<=C.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(P(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(xs.indexOf(t.toLowerCase())===-1||!(s in C))return!1;let i=C[s];if(t==A&&!(this._kings[e]==T||this._kings[e]==i))return!1;let r=this._board[i];return r&&r.type===A&&(this._kings[r.color]=T),this._set(i,{type:t,color:e}),t===A&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let e=this.get(t);return this._clear(C[t]),e&&e.type===A&&(this._kings[e.color]=T),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[C.e1]?.type===A&&this._board[C.e1]?.color===I,e=this._board[C.e8]?.type===A&&this._board[C.e8]?.color===L;(!t||this._board[C.a1]?.type!==se||this._board[C.a1]?.color!==I)&&(this._castling.w&=-65),(!t||this._board[C.h1]?.type!==se||this._board[C.h1]?.color!==I)&&(this._castling.w&=-33),(!e||this._board[C.a8]?.type!==se||this._board[C.a8]?.color!==L)&&(this._castling.b&=-65),(!e||this._board[C.h8]?.type!==se||this._board[C.h8]?.color!==L)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===T)return;let t=this._epSquare+(this._turn===I?-16:16),e=this._epSquare+(this._turn===I?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==te(this._turn)||this._board[e]?.type!==x){this._hash^=this._epKey(),this._epSquare=T;return}let i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===x;s.some(i)||(this._hash^=this._epKey(),this._epSquare=T)}_attacked(t,e,s){let i=[];for(let r=C.a8;r<=C.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==t)continue;let o=this._board[r],f=r-e;if(f===0)continue;let u=f+119;if(Ss[u]&$s[o.type]){if(o.type===x){if(f>0&&o.color===I||f<=0&&o.color===L)if(s)i.push(P(r));else return!0;continue}if(o.type==="n"||o.type==="k")if(s){i.push(P(r));continue}else return!0;let d=ws[u],m=r+d,k=!1;for(;m!==e;){if(this._board[m]!=null){k=!0;break}m+=d}if(!k)if(s){i.push(P(r));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){let e=this._kings[t];return e===-1?!1:this._attacked(te(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},e=[],s=0,i=0;for(let r=C.a8;r<=C.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}let o=this._board[r];o&&(t[o.type]=o.type in t?t[o.type]+1:1,o.type===he&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[he]===1||t[$e]===1))return!0;if(s===t[he]+2){let r=0,o=e.length;for(let f=0;f<o;f++)r+=e[f];if(r===0||r===o)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){let i=this._moves({square:e,piece:s});return t?i.map(r=>new J(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){let i=s?s.toLowerCase():void 0,r=e?.toLowerCase(),o=[],f=this._turn,u=te(f),d=C.a8,m=C.h1,k=!1;if(i)if(i in C)d=m=C[i],k=!0;else return[];for(let b=d;b<=m;b++){if(b&136){b+=7;continue}if(!this._board[b]||this._board[b].color===u)continue;let{type:S}=this._board[b],$;if(S===x){if(r&&r!==S)continue;$=b+ye[f][0],this._board[$]||(D(o,f,b,$,x),$=b+ye[f][1],Is[f]===W(b)&&!this._board[$]&&D(o,f,b,$,x,void 0,y.BIG_PAWN));for(let O=2;O<4;O++)$=b+ye[f][O],!($&136)&&(this._board[$]?.color===u?D(o,f,b,$,x,this._board[$].type,y.CAPTURE):$===this._epSquare&&D(o,f,b,$,x,x,y.EP_CAPTURE))}else{if(r&&r!==S)continue;for(let O=0,Q=nt[S].length;O<Q;O++){let z=nt[S][O];for($=b;$+=z,!($&136);){if(!this._board[$])D(o,f,b,$,S);else{if(this._board[$].color===f)break;D(o,f,b,$,S,this._board[$].type,y.CAPTURE);break}if(S===$e||S===A)break}}}}if((r===void 0||r===A)&&(!k||m===this._kings[f])){if(this._castling[f]&y.KSIDE_CASTLE){let b=this._kings[f],S=b+2;!this._board[b+1]&&!this._board[S]&&!this._attacked(u,this._kings[f])&&!this._attacked(u,b+1)&&!this._attacked(u,S)&&D(o,f,this._kings[f],S,A,void 0,y.KSIDE_CASTLE)}if(this._castling[f]&y.QSIDE_CASTLE){let b=this._kings[f],S=b-2;!this._board[b-1]&&!this._board[b-2]&&!this._board[b-3]&&!this._attacked(u,this._kings[f])&&!this._attacked(u,b-1)&&!this._attacked(u,S)&&D(o,f,this._kings[f],S,A,void 0,y.QSIDE_CASTLE)}}if(!t||this._kings[f]===-1)return o;let p=[];for(let b=0,S=o.length;b<S;b++)this._makeMove(o[b]),this._isKingAttacked(f)||p.push(o[b]),this._undoMove();return p}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Se,e);else if(typeof t=="object"){let r=this._moves();for(let o=0,f=r.length;o<f;o++)if(t.from===P(r[o].from)&&t.to===P(r[o].to)&&(!("promotion"in r[o])||t.promotion===r[o].promotion)){s=r[o];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&y.NULL_MOVE)throw new Error("Null move not allowed when in check");let i=new J(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){let e=this._turn,s=te(e);if(this._push(t),t.flags&y.NULL_MOVE){e===L&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=T;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&y.EP_CAPTURE&&(this._turn===L?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===A){if(this._kings[e]=t.to,t.flags&y.KSIDE_CASTLE){let i=t.to-1,r=t.to+1;this._movePiece(r,i)}else if(t.flags&y.QSIDE_CASTLE){let i=t.to+1,r=t.to-2;this._movePiece(r,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,r=B[e].length;i<r;i++)if(t.from===B[e][i].square&&this._castling[e]&B[e][i].flag){this._castling[e]^=B[e][i].flag;break}}if(this._castling[s]){for(let i=0,r=B[s].length;i<r;i++)if(t.to===B[s][i].square&&this._castling[s]&B[s][i].flag){this._castling[s]^=B[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&y.BIG_PAWN){let i;e===L?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===x&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===x&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=T}else this._epSquare=T;t.piece===x?this._halfMoves=0:t.flags&(y.CAPTURE|y.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===L&&this._moveNumber++,this._turn=s,this._hash^=Ee}undo(){let t=this._hash,e=this._undoMove();if(e){let s=new J(this,e);return this._decPositionCount(t),s}return null}_undoMove(){let t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Ee;let s=this._turn,i=te(s);if(e.flags&y.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&y.EP_CAPTURE){let r;s===L?r=e.to-16:r=e.to+16,this._set(r,{type:x,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(y.KSIDE_CASTLE|y.QSIDE_CASTLE)){let r,o;e.flags&y.KSIDE_CASTLE?(r=e.to+1,o=e.to-1):(r=e.to-2,o=e.to+1),this._movePiece(o,r)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){let s=[],i=!1;for(let p in this._header)this._header[p]&&s.push(`[${p} "${this._header[p]}"]`+t),i=!0;i&&this._history.length&&s.push(t);let r=p=>{let b=this._comments[this.fen()];if(typeof b<"u"){let S=p.length>0?" ":"";p=`${p}${S}{${b}}`}return p},o=[];for(;this._history.length>0;)o.push(this._undoMove());let f=[],u="";for(o.length===0&&f.push(r(""));o.length>0;){u=r(u);let p=o.pop();if(!p)break;if(!this._history.length&&p.color==="b"){let b=`${this._moveNumber}. ...`;u=u?`${u} ${b}`:b}else p.color==="w"&&(u.length&&f.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(p,this._moves({legal:!0})),this._makeMove(p)}if(u.length&&f.push(r(u)),f.push(this._header.Result||"*"),e===0)return s.join("")+f.join(" ");let d=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},m=function(p,b){for(let S of b.split(" "))if(S){if(p+S.length>e){for(;d();)p--;s.push(t),p=0}s.push(S),p+=S.length,s.push(" "),p++}return d()&&p--,p},k=0;for(let p=0;p<f.length;p++){if(k+f[p].length>e&&f[p].includes("{")){k=m(k,f[p]);continue}k+f[p].length>e&&p!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),k=0):p!==0&&(s.push(" "),k++),s.push(f[p]),k+=f[p].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??xe[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=xe[t]||null,!0):!1}getHeaders(){let t={};for(let[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));let i=_s(t);this.reset();let r=i.headers,o="";for(let d in r)d.toLowerCase()==="fen"&&(o=r[d]),this.header(d,r[d]);if(!e)o&&this.load(o,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let f=i.root;for(;f;){if(f.move){let d=this._moveFromSan(f.move,e);if(d==null)throw new Error(`Invalid move in PGN: ${f.move}`);this._makeMove(d),this._incPositionCount()}f.comment!==void 0&&(this._comments[this.fen()]=f.comment),f=f.variations[0]}let u=i.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&y.KSIDE_CASTLE)s="O-O";else if(t.flags&y.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&y.NULL_MOVE)return Se;if(t.piece!==x){let i=Os(t,e);s+=t.piece.toUpperCase()+i}t.flags&(y.CAPTURE|y.EP_CAPTURE)&&(t.piece===x&&(s+=P(t.from)[0]),s+="x"),s+=P(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=we(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Se)return{color:this._turn,from:0,to:0,piece:"k",flags:y.NULL_MOVE};let i=ot(s),r=this._moves({legal:!0,piece:i});for(let p=0,b=r.length;p<b;p++)if(s===we(this._moveToSan(r[p],r)))return r[p];if(e)return null;let o,f,u,d,m,k=!1;if(f=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),f?(o=f[1],u=f[2],d=f[3],m=f[4],u.length==1&&(k=!0)):(f=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),f&&(o=f[1],u=f[2],d=f[3],m=f[4],u.length==1&&(k=!0))),i=ot(s),r=this._moves({legal:!0,piece:o||i}),!d)return null;for(let p=0,b=r.length;p<b;p++)if(u){if((!o||o.toLowerCase()==r[p].piece)&&C[u]==r[p].from&&C[d]==r[p].to&&(!m||m.toLowerCase()==r[p].promotion))return r[p];if(k){let S=P(r[p].from);if((!o||o.toLowerCase()==r[p].piece)&&C[d]==r[p].to&&(u==S[0]||u==S[1])&&(!m||m.toLowerCase()==r[p].promotion))return r[p]}}else if(s===we(this._moveToSan(r[p],r)).replace("x",""))return r[p];return null}ascii(){let t=`   +------------------------+
`;for(let e=C.a8;e<=C.h1;e++){if(ie(e)===0&&(t+=" "+"87654321"[W(e)]+" |"),this._board[e]){let s=this._board[e].type,r=this._board[e].color===I?s.toUpperCase():s.toLowerCase();t+=" "+r+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){let e=this._moves({legal:!1}),s=0,i=this._turn;for(let r=0,o=e.length;r<o;r++)this._makeMove(e[r]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],e=[];for(let s=C.a8;s<=C.h1;s++)this._board[s]==null?e.push(null):e.push({square:P(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in C){let e=C[t];return(W(e)+ie(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){let e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){let i=e.pop();if(!i)break;t?s.push(new J(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){let t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){let i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(let i of[A,U])e[i]!==void 0&&(e[i]?this._castling[t]|=le[i]:this._castling[t]&=~le[i]);this._updateCastlingRights();let s=this.getCastlingRights(t);return(e[A]===void 0||e[A]===s[A])&&(e[U]===void 0||e[U]===s[U])}getCastlingRights(t){return{[A]:(this._castling[t]&le[A])!==0,[U]:(this._castling[t]&le[U])!==0}}moveNumber(){return this._moveNumber}};var Ls=(n=Me)=>({headers:n(),moves:new pe}),pe=class{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){let e=t.children[0];yield e,t=e}}*mainline(){for(let t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}},Pe=class extends pe{constructor(t){super(),this.data=t}};var Rs=n=>n?n.winner==="white"?"1-0":n.winner==="black"?"0-1":"1/2-1/2":"*",Ks=n=>n==="1-0"||n==="1\u20130"||n==="1\u20140"?{winner:"white"}:n==="0-1"||n==="0\u20131"||n==="0\u20141"?{winner:"black"}:n==="1/2-1/2"||n==="1/2\u20131/2"||n==="1/2\u20141/2"?{winner:void 0}:void 0;var Me=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]);var ct="\uFEFF",Ae=n=>/^\s*$/.test(n),Ne=n=>n.startsWith("%"),Te=class extends Error{},Ie=class{constructor(t,e=Me,s=1e6){this.emitGame=t,this.initHeaders=e,this.maxBudget=s,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Ls(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Te("ERR_PGN_BUDGET")}parse(t,e){if(!(this.budget<0))try{let s=0;for(;;){let i=t.indexOf(`
`,s);if(i===-1)break;let r=i>s&&t[i-1]==="\r"?i-1:i;this.consumeBudget(i-s),this.lineBuf.push(t.slice(s,r)),s=i+1,this.handleLine()}this.consumeBudget(t.length-s),this.lineBuf.push(t.slice(s)),e?.stream||(this.handleLine(),this.emit(void 0))}catch(s){this.emit(s)}}handleLine(){let t=!0,e=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:e.startsWith(ct)&&(e=e.slice(ct.length)),this.state=1;case 1:if(Ae(e)||Ne(e))return;this.found=!0,this.state=2;case 2:{if(Ne(e))return;let s=!0;for(;s;)s=!1,e=e.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(i,r,o)=>(this.consumeBudget(200),this.handleHeader(r,o.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),s=!0,t=!1,""));if(Ae(e))return;this.state=3}case 3:{if(t){if(Ne(e))return;if(Ae(e))return this.emit(void 0)}let s=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g,i;for(;i=s.exec(e);){let r=this.stack[this.stack.length-1],o=i[0];if(o===";")return;if(o.startsWith("$"))this.handleNag(parseInt(o.slice(1),10));else if(o==="!")this.handleNag(1);else if(o==="?")this.handleNag(2);else if(o==="!!")this.handleNag(3);else if(o==="??")this.handleNag(4);else if(o==="!?")this.handleNag(5);else if(o==="?!")this.handleNag(6);else if(o==="1-0"||o==="1\u20130"||o==="1\u20140"||o==="0-1"||o==="0\u20131"||o==="0\u20141"||o==="1/2-1/2"||o==="1/2\u20131/2"||o==="1/2\u20141/2"||o==="*")this.stack.length===1&&o!=="*"&&this.handleHeader("Result",o);else if(o==="(")this.consumeBudget(100),this.stack.push({parent:r.parent,root:!1});else if(o===")")this.stack.length>1&&this.stack.pop();else if(o==="{"){let f=s.lastIndex,u=e[f]===" "?f+1:f;e=e.slice(u),this.state=4;continue e}else this.consumeBudget(100),o.startsWith("O")||o.startsWith("0")||o.startsWith("o")?o=o.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(o==="Z0"||o==="0000"||o==="@@@@")&&(o="--"),r.node&&(r.parent=r.node),r.node=new Pe({san:o,startingComments:r.startingComments}),r.startingComments=void 0,r.root=!1,r.parent.children.push(r.node)}return}case 4:{let s=e.indexOf("}");if(s===-1){this.commentBuf.push(e);return}else{let i=s>0&&e[s-1]===" "?s-1:s;this.commentBuf.push(e.slice(0,i)),this.handleComment(),e=e.slice(s),this.state=3,t=!1}}}}handleHeader(t,e){this.game.headers.set(t,t==="Result"?Rs(Ks(e)):e)}handleNag(t){var e;this.consumeBudget(50);let s=this.stack[this.stack.length-1];s.node&&((e=s.node.data).nags||(e.nags=[]),s.node.data.nags.push(t))}handleComment(){var t,e;this.consumeBudget(100);let s=this.stack[this.stack.length-1],i=this.commentBuf.join(`
`);this.commentBuf=[],s.node?((t=s.node.data).comments||(t.comments=[]),s.node.data.comments.push(i)):s.root?((e=this.game).comments||(e.comments=[]),this.game.comments.push(i)):(s.startingComments||(s.startingComments=[]),s.startingComments.push(i))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}},ht=(n,t=Me)=>{let e=[];return new Ie(s=>e.push(s),t,NaN).parse(n),e};var G=[],de=[],ge=new Map;addEventListener("message",({data:n})=>{try{switch(n.type){case"load":Fs(n.payload,n.id);break;case"filter":qs(n.payload,n.id);break;case"loadGame":Bs(n.payload,n.id);break}}catch(t){postMessage({type:"error",payload:String(t),id:n.id})}});function Fs(n,t){G=[],de=[],ge.clear(),G=Ds(n).filter(s=>{let i=s.match(/\[Variant\s+"([^"]+)"\]/);return i?i[1]==="Standard":!0}),de=G.map((s,i)=>Us(s,i)),postMessage({type:"load",id:t,payload:{count:G.length,metadata:de}})}function qs(n,t){let{white:e,black:s,result:i,moves:r,ignoreColor:o,targetMoves:f}=n,u=e.toLowerCase(),d=s.toLowerCase(),m=i.toLowerCase(),k=[];for(let p=0;p<G.length;p++){let b=de[p],S=b.white.toLowerCase(),$=b.black.toLowerCase(),O=!0,Q=!0;if(o?(u&&!(S.includes(u)||$.includes(u))&&(O=!1),d&&!(S.includes(d)||$.includes(d))&&(Q=!1)):(u&&!S.includes(u)&&(O=!1),d&&!$.includes(d)&&(Q=!1)),!(!O||!Q)&&!(m&&!b.result.toLowerCase().includes(m))){if(r&&f.length>0){let z=G[p];if(!z.includes(f[0]))continue;let q=ge.get(p);if(q||(q=Gs(z),ge.set(p,q)),!q)continue;let Y=!0;if(f.length>q.length)Y=!1;else for(let H=0;H<f.length;H++)if(q[H]!==f[H]){Y=!1;break}if(!Y)continue}k.push(p)}}postMessage({type:"filter",id:t,payload:k})}function Bs(n,t){if(n<0||n>=G.length)throw new Error("Game index out of bounds");let e=G[n],s=[],i,r=e;try{let o=new fe;r=r.replace(/([a-h1-8NBRQK])([?!]+)/g,"$1"),r=r.replace(/\}\s*\{/g," "),r=r.replace(/\]\s*\[/g,`]
[`),r=r.replace(/\]\s*(\d+\.|[a-hNBRQK]|\*|1-0|0-1|1\/2-1\/2)/g,`]

$1`),r=r.replace(/\d+\.\.\./g," "),r=r.replace(/\$\d+/g,"");try{o.loadPgn(r),s=o.history()}catch(f){console.warn("Strict parsing failed, trying chessops fallback",f);try{let u=ht(r);if(u.length>0){let d=u[0];s=[];let m=d.moves;for(;m.children.length>0;){let k=m.children[0];k.data&&k.data.san&&s.push(k.data.san),m=k}i=void 0}else throw new Error("Chessops found no games")}catch(u){console.warn("Chessops parsing failed, retrying with stripped comments",u),r=r.replace(/\{[^}]*\}/g,""),r=r.replace(/\([^)]*\)/g,""),r=r.replace(/\s+/g," "),o.loadPgn(r),s=o.history(),i=void 0}}ge.set(n,s)}catch(o){console.error("Error parsing game moves",o),i=String(o),s=[]}postMessage({type:"loadGame",id:t,payload:{moves:s,pgn:r,error:i}})}function Ds(n){let t=n.split(/(?=\[Event\s+")/),e=[];for(let s of t){let i=s.trim();i.length>0&&/^\[Event\s+"/.test(i)&&e.push(i)}return e}function Us(n,t){let e=n.match(/\[White\s+"([^"]+)"\]/),s=n.match(/\[Black\s+"([^"]+)"\]/),i=n.match(/\[Result\s+"([^"]+)"\]/),r=n.match(/\[WhiteElo\s+"([^"]+)"\]/),o=n.match(/\[BlackElo\s+"([^"]+)"\]/),f=n.match(/\[WhiteTitle\s+"([^"]+)"\]/),u=n.match(/\[BlackTitle\s+"([^"]+)"\]/),d=e?e[1]:"Unknown",m=s?s[1]:"Unknown",k=i?i[1]:"*";f&&(d=`${f[1]} ${d}`),r&&(d=`${d} (${r[1]})`),u&&(m=`${u[1]} ${m}`),o&&(m=`${m} (${o[1]})`);let p=k;return k==="1-0"?p="1-0":k==="0-1"?p="0-1":k==="1/2-1/2"&&(p="\xBD-\xBD"),{number:t+1,white:d,black:m,result:p}}function Gs(n){let t=n,e=n.lastIndexOf("]");return e!==-1&&(t=n.substring(e+1)),t=t.replace(/\{[^}]*\}/g," "),t=t.replace(/\([^)]*\)/g," "),t=t.replace(/;.*$/gm," "),t=t.replace(/\d+\.+/g," "),t=t.replace(/(1-0|0-1|1\/2-1\/2|\*)/g," "),t.trim().split(/\s+/).filter(s=>s.length>0&&s!==".")}
